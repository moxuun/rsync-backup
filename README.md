# VPS to NAS 备份与迁移工具

本脚本用于将 VPS 数据（Docker 卷与物理目录）备份至 NAS，支持冷备份一致性保证及一次性迁移模式。

---

## 核心功能

* **冷备份**：自动停启容器，确保数据库等应用数据一致。
* **双模式**：
* **备份模式**：通过 Rsync 推送至远程 NAS 并自动清理过期文件。
* **迁移模式**：仅在本地打包，便于通过 SFTP 手动下载。


* **多目标支持**：同步备份 Docker Volume 与普通物理路径。

---

## 运行流程

| 阶段 | 动作 | 说明 |
| --- | --- | --- |
| **准备** | 环境检查 | 验证 SSH 连通性（迁移模式跳过） |
| **打包** | 冷备份处理 | 停止容器 -> 数据压缩 -> 立即恢复容器 |
| **传输** | 逻辑分流 | **备份**：Rsync 传输；**迁移**：保留本地包并退出 |
| **收尾** | 自动清理 | 删除本地临时缓存及远程过期备份 |

---

## 快速配置

修改脚本顶部的配置项：

### 模式切换

* `MIGRATION_ONLY`: `true` (仅本地打包) 或 `false` (同步至 NAS)。

### 路径与容器

* `CONTAINERS_TO_STOP`: 备份时需暂停的容器名。
* `VOLUMES_TO_BACKUP`: 需备份的 Docker 卷名。
* `DIRS_TO_BACKUP`: 需备份的宿主机绝对路径。

### 远程信息

* `NAS_USER` / `NAS_HOST` / `NAS_TARGET_DIR`: 远程登录及存储路径。
* `RETENTION_DAYS`: 远程备份保留天数。

---

## 使用指南

### 1. 基础准备

配置 SSH 免密登录以确保自动化运行：

```bash
ssh-copy-id -i ~/.ssh/id_ed25519.pub USER@NAS_IP

```

### 2. 执行权限

```bash
chmod +x backup.sh

```

### 3. 定时备份 (Crontab)

每日凌晨 3 点执行：

```bash
00 03 * * * /path/to/backup.sh >> /var/log/vps_backup.log 2>&1

```

---

## 注意事项

* **存储预算**：确保 `LOCAL_TEMP_ROOT` 有足够空间容纳两倍于原始数据的压缩包。
* **手动清理**：在迁移模式下，脚本不会自动删除本地生成的压缩包，下载后请手动释放空间。
