# VPS to NAS 备份与迁移工具

本脚本用于将 VPS 数据备份至远程 NAS。支持冷备份一致性保证、一次性迁移模式以及 Telegram 状态通知。

---

## 核心功能

* 冷备份处理：自动停启容器，确保数据库等应用数据在备份时处于静止状态。
* 双模式运行：
* 备份模式：通过 Rsync 推送至远程 NAS，任务完成后自动清理本地缓存及远程过期文件。
* 迁移模式：仅在本地打包，不连接远程服务器，便于通过 SFTP 手动下载。


* 状态通知：任务启动、成功、失败均通过 Telegram Bot 推送详细报告。
* 兼容性：通知采用 HTML 解析模式，支持包含下划线的文件名与日期格式。

---

## 运行流程

| 阶段 | 动作 | 说明 |
| --- | --- | --- |
| 准备 | 环境检查 | 验证 SSH 连通性并检查本地目录，失败则发送通知并退出 |
| 打包 | 冷备份处理 | 停止容器 -> 数据压缩并记录明细 -> 恢复容器 |
| 传输 | 逻辑分流 | 备份模式执行 Rsync 同步；迁移模式保留本地包并结束 |
| 收尾 | 自动清理 | 成功同步后删除本地缓存，并根据保留策略清理远程旧备份 |
| 通知 | 状态推送 | 汇总备份大小、时间、文件明细并通过 Telegram 发送最终报告 |

---

## 快速配置

修改脚本顶部的变量：

### 模式与路径

* MIGRATION_ONLY：设为 true 仅本地打包，设为 false 执行远程同步。
* LOCAL_TEMP_ROOT：本地临时存放压缩包的根目录。
* RETENTION_DAYS：远程 NAS 备份保留的天数。

### 备份对象

* CONTAINERS_TO_STOP：备份期间需要暂停的容器列表（空格分隔）。
* VOLUMES_TO_BACKUP：需要备份的 Docker 卷名。
* DIRS_TO_BACKUP：需要备份的宿主机绝对路径。

### 远程与通知

* NAS_USER / NAS_HOST / NAS_TARGET_DIR：NAS 的登录信息与存储路径。
* TG_BOT_TOKEN / TG_CHAT_ID：Telegram 机器人的 API 令牌与接收通知的 ID。

---

## 使用指南

### 1. 基础准备

配置 SSH 免密登录：

```bash
ssh-copy-id -i ~/.ssh/id_ed25519.pub USER@NAS_IP

```

第一次运行脚本前，请手动 ssh 连接一次 NAS 以接受主机指纹。

### 2. 权限设置

```bash
chmod +x backup.sh

```

### 3. 定时任务

通过 crontab 设置每日凌晨 3 点执行：

```bash
00 03 * * * /path/to/backup.sh >> /var/log/vps_backup.log 2>&1

```

---

## 注意事项

* 磁盘空间：确保本地临时目录有足够空间容纳两倍于原始数据的压缩文件。
* 通知安全：HTML 解析模式下，请勿在备份对象名称中使用包含未闭合的 HTML 标签符号（如 < 或 >），以免破坏通知格式。
* 迁移模式：该模式下脚本不会自动执行本地清理，手动下载完成后请自行删除临时文件。
