# VPS to NAS 自动备份脚本 (Rsync 版)

这是一个基于 Bash 编写的轻量级备份工具，旨在将 VPS 上的重要数据（包括 Docker 容器卷和普通物理目录）通过 Rsync 加密传输至本地 NAS（如 Armbian、Synology 或其他运行 Linux 的设备）。

## 主要功能

* **一致性备份**：支持在备份期间自动停止和重启指定的 Docker 容器（冷备份），确保数据库等应用的数据一致性。
* **多类型支持**：同时支持备份 Docker Volume 和普通的 Linux 文件系统目录。
* **高效传输**：利用 Rsync 增量传输特性，并结合 SSH 进行加密通讯。
* **自动化清理**：具备本地临时文件清理功能，并能通过 SSH 远程触发 NAS 端的旧备份删除逻辑。
* **容错检查**：在执行备份前会预先检测 SSH 连通性，避免无效运行。

---

## 备份流程说明

脚本运行后的逻辑步骤如下表所示：

| 步骤 | 动作 | 说明 |
| --- | --- | --- |
| 1 | 预检查 | 测试与 NAS 的 SSH 连接是否正常 |
| 2 | 环境准备 | 在本地创建以时间戳命名的临时目录 |
| 3 | 业务暂停 | 停止配置文件中定义的关键容器 |
| 4 | 数据打包 | 将 Docker 卷和普通目录压缩为 `.tar.gz` |
| 5 | 恢复运行 | 立即重启容器以缩短业务中断时间 |
| 6 | 远程同步 | 使用 Rsync 将压缩包推送到 NAS |
| 7 | 后期清理 | 删除本地临时文件，并清理 NAS 上的过期备份 |

---

## 配置指南

在使用脚本前，请根据您的环境修改脚本开头的配置区域。

### 1. 基础配置

* **NAS_USER**: NAS 的登录用户名。
* **NAS_HOST**: NAS 的内网 IP 地址或域名（需 VPS 可通过网络访问）。
* **NAS_TARGET_DIR**: NAS 上存放备份文件的绝对路径。

### 2. 备份内容配置

* **CONTAINERS_TO_STOP**: 填入需要在备份时停止的容器名称（如数据库），多个容器用空格分隔。
* **VOLUMES_TO_BACKUP**: 需要备份的 Docker 卷名称。
* **DIRS_TO_BACKUP**: 需要备份的普通文件夹路径（绝对路径）。

### 3. 保留策略

* **RETENTION_DAYS**: 设置 NAS 上备份保留的天数，超过此时间的旧备份文件夹将被自动删除。

---

## 前置准备：配置 SSH 免密登录

为了实现脚本的自动化运行，您必须配置 VPS 到 NAS 的 **SSH 密钥对认证**，否则脚本会在 Rsync 传输和远程清理时因等待输入密码而卡死。

1. 在 VPS 上生成密钥（如果已有则跳过）：
`ssh-keygen -t ed25519`
2. 将公钥发送到 NAS：
`ssh-copy-id -i ~/.ssh/id_ed25519.pub admin@192.168.1.2`
3. 手动测试连接：
`ssh admin@192.168.1.2`（若无需密码即可登录，则配置成功）

---

## 使用方法

### 1. 赋予执行权限

```bash
chmod +x backup_to_nas.sh

```

### 2. 手动测试

```bash
./backup_to_nas.sh

```

### 3. 配置定时任务 (Crontab)

若希望每天凌晨 3:00 自动备份，可执行 `crontab -e` 并添加以下内容：

```cron
00 03 * * * /path/to/backup_to_nas.sh >> /var/log/vps_backup.log 2>&1

```

---

## 注意事项

* **存储空间**：请确保 VPS 本地的 `LOCAL_TEMP_ROOT` 路径有足够的临时空间用于存放压缩包。
* **安全性**：建议在 NAS 端为备份账户设置严格的目录访问权限。
* **网络环境**：若 VPS 与 NAS 之间通过公网连接，请务必使用非标准 SSH 端口，并在脚本中修改相应的 Rsync 参数。

